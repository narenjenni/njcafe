<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order • NJ Cafe — Aurora UI</title>
  <meta name="description" content="Pemesanan online NJ Cafe: 25 menu, catatan per item, WhatsApp & Email serverless." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="blob a"></div><div class="blob b"></div><div class="blob c"></div>

  <nav>
    <div class="container navbar">
      <a href="index.html" class="brand"><span class="brand-badge"></span><strong>NJ Cafe</strong></a>
      <div class="navlinks">
        <a href="index.html#menu">Menu</a>
        <a href="index.html#owner">Owner</a>
        <a href="index.html#bahan">Bahan</a>
        <a href="order.html" class="cta ripple">Order</a>
      </div>
      <button class="burger" id="burger">☰</button>
    </div>
    <div class="container mobilemenu" id="mobile">
      <a href="index.html#menu">Menu</a>
      <a href="index.html#owner">Owner</a>
      <a href="index.html#bahan">Bahan</a>
      <a href="order.html" class="cta ripple">Order</a>
    </div>
  </nav>

  <main class="container" style="padding:24px 0">
    <div class="toolbar">
      <div class="row">
        <input id="q" class="input" placeholder="Cari menu...">
        <select id="sort" class="select">
          <option value="name-asc">A → Z</option>
          <option value="name-desc">Z → A</option>
          <option value="price-asc">Harga Terendah</option>
          <option value="price-desc">Harga Tertinggi</option>
        </select>
        <div class="chips" id="cats">
          <button data-cat="" class="button ghost ripple">Semua</button>
          <button data-cat="Minuman" class="button ghost ripple">Minuman</button>
          <button data-cat="Makanan" class="button ghost ripple">Makanan</button>
        </div>
        <button class="button primary ripple" onclick="openDrawer()">Keranjang</button>
      </div>
      <p class="lead" style="margin-top:10px">Tambahkan catatan per item (contoh: “tidak pedas ya”).</p>
    </div>

    <div class="layout" style="margin-top:20px">
      <section><div id="grid" class="grid menu"></div></section>

      <aside class="cart" id="cartSide">
        <h3 style="margin:0 0 8px; font-weight:900">Keranjang <span id="countSide" class="chip">0</span></h3>
        <div id="listSide" class="list"></div>
        <div style="border-top:1px solid var(--line); padding-top:10px; margin-top:10px">
          <div class="row"><span>Subtotal</span><strong id="subSide">Rp 0</strong></div>
          <div class="row"><span>Pajak (10%)</span><strong id="taxSide">Rp 0</strong></div>
          <div class="row" style="border:none"><span style="font-weight:900">Total</span><strong id="totSide">Rp 0</strong></div>
        </div>

        <div class="kv" style="margin-top:12px">
          <div class="flex" style="gap:8px; margin-bottom:8px">
            <input id="nameSide" class="input" placeholder="Nama lengkap">
            <input id="phoneSide" class="input" placeholder="No. HP">
          </div>
          <div class="flex" style="gap:8px; margin-bottom:8px">
            <select id="typeSide" class="select">
              <option value="Dine-in">Dine-in</option><option value="Takeaway">Takeaway</option><option value="Delivery">Delivery</option>
            </select>
            <input id="addrSide" class="input" placeholder="Meja/Alamat (opsional)">
          </div>
          <textarea id="noteSide" class="textarea" rows="2" placeholder="Catatan umum pesanan (opsional)"></textarea>
        </div>

        <div class="flex" style="margin-top:12px">
          <button class="button primary ripple" style="flex:1" onclick="sendWhatsApp()">Kirim WhatsApp</button>
          <button class="button ripple" style="flex:1" onclick="sendEmailServerless(this)">Kirim Email</button>
        </div>
        <div style="color:var(--muted); font-size:12px; margin-top:6px">Email dikirim via serverless function.</div>
      </aside>
    </div>
  </main>

  <button class="fab ripple" onclick="openDrawer()">Keranjang <span id="badge" class="chip" style="margin-left:6px">0</span></button>

  <div id="drawer" class="drawer" role="dialog" aria-hidden="true">
    <div style="display:flex; align-items:center; justify-content:space-between">
      <strong style="font-size:18px">Keranjang <span id="countDrawer" class="chip">0</span></strong>
      <button class="button ripple" onclick="closeDrawer()">Tutup</button>
    </div>

    <div id="listDrawer" class="list" style="margin-top:10px"></div>

    <div style="border-top:1px solid var(--line); padding-top:10px; margin-top:10px">
      <div class="row"><span>Subtotal</span><strong id="subDrawer">Rp 0</strong></div>
      <div class="row"><span>Pajak (10%)</span><strong id="taxDrawer">Rp 0</strong></div>
      <div class="row" style="border:none"><span style="font-weight:900">Total</span><strong id="totDrawer">Rp 0</strong></div>
    </div>

    <div class="kv" style="margin-top:12px">
      <div class="flex" style="gap:8px; margin-bottom:8px">
        <input id="nameDrawer" class="input" placeholder="Nama lengkap">
        <input id="phoneDrawer" class="input" placeholder="No. HP">
      </div>
      <div class="flex" style="gap:8px; margin-bottom:8px">
        <select id="typeDrawer" class="select">
          <option value="Dine-in">Dine-in</option><option value="Takeaway">Takeaway</option><option value="Delivery">Delivery</option>
        </select>
        <input id="addrDrawer" class="input" placeholder="Meja/Alamat (opsional)">
      </div>
      <textarea id="noteDrawer" class="textarea" rows="2" placeholder="Catatan umum pesanan (opsional)"></textarea>
    </div>

    <div class="flex" style="margin-top:12px">
      <button class="button primary ripple" style="flex:1" onclick="sendWhatsApp()">Kirim WhatsApp</button>
      <button class="button ripple" style="flex:1" onclick="sendEmailServerless(this)">Kirim Email</button>
    </div>
  </div>
  <div id="mask" class="drawer-mask" onclick="closeDrawer()"></div>

  <div id="toast" class="toast"><div class="inner">Ditambahkan ke keranjang</div></div>

  <script>
    // NAV
    document.getElementById('burger').addEventListener('click', ()=> {
      const mob = document.getElementById('mobile');
      mob.style.display = mob.style.display==='block'?'none':'block';
    });
    document.body.addEventListener('click', e => {
      const btn = e.target.closest('.ripple'); if(!btn) return;
      const r = btn.getBoundingClientRect(); btn.style.setProperty('--x', (e.clientX-r.left)+'px'); btn.style.setProperty('--y', (e.clientY-r.top)+'px');
      btn.classList.remove('rippling'); void btn.offsetWidth; btn.classList.add('rippling');
    }, {capture:true});

    // MENU DATA
    const MENU = [
      {id:1,name:"Espresso",price:18000,cat:"Minuman",img:"assets/menu-01.svg",ing:["Arabika single shot"]},
      {id:2,name:"Americano",price:22000,cat:"Minuman",img:"assets/menu-02.svg",ing:["Espresso","Air panas"]},
      {id:3,name:"Cappuccino",price:28000,cat:"Minuman",img:"assets/menu-03.svg",ing:["Espresso","Susu steamed","Foam"]},
      {id:4,name:"Caffè Latte",price:28000,cat:"Minuman",img:"assets/menu-04.svg",ing:["Espresso","Susu steamed"]},
      {id:5,name:"Caramel Macchiato",price:32000,cat:"Minuman",img:"assets/menu-05.svg",ing:["Espresso","Susu","Saus karamel"]},
      {id:6,name:"Mocha",price:32000,cat:"Minuman",img:"assets/menu-06.svg",ing:["Espresso","Susu","Cokelat bubuk"]},
      {id:7,name:"Matcha Latte",price:32000,cat:"Minuman",img:"assets/menu-07.svg",ing:["Matcha","Susu"]},
      {id:8,name:"Chocolate",price:28000,cat:"Minuman",img:"assets/menu-08.svg",ing:["Cokelat bubuk","Susu"]},
      {id:9,name:"Thai Tea",price:24000,cat:"Minuman",img:"assets/menu-09.svg",ing:["Teh Thailand","Susu kental"]},
      {id:10,name:"Lemon Tea",price:20000,cat:"Minuman",img:"assets/menu-10.svg",ing:["Teh","Lemon segar"]},
      {id:11,name:"Iced Lychee Tea",price:26000,cat:"Minuman",img:"assets/menu-11.svg",ing:["Teh","Leci","Es batu"]},
      {id:12,name:"Strawberry Smoothie",price:30000,cat:"Minuman",img:"assets/menu-12.svg",ing:["Stroberi","Yogurt/susu","Es"]},
      {id:13,name:"Mango Smoothie",price:30000,cat:"Minuman",img:"assets/menu-13.svg",ing:["Mangga","Yogurt/susu","Es"]},
      {id:14,name:"Croissant",price:18000,cat:"Makanan",img:"assets/menu-14.svg",ing:["Adonan butter berlapis"]},
      {id:15,name:"Donut Glaze",price:12000,cat:"Makanan",img:"assets/menu-15.svg",ing:["Donat kentang","Glaze gula"]},
      {id:16,name:"French Fries",price:20000,cat:"Makanan",img:"assets/menu-16.svg",ing:["Kentang","Garam","Minyak"]},
      {id:17,name:"Chicken Wings (6pcs)",price:38000,cat:"Makanan",img:"assets/menu-17.svg",ing:["Sayap ayam","Marinade pedas"]},
      {id:18,name:"Spaghetti Bolognese",price:38000,cat:"Makanan",img:"assets/menu-18.svg",ing:["Tomat","Daging sapi cincang","Herbs"]},
      {id:19,name:"Spaghetti Aglio e Olio",price:34000,cat:"Makanan",img:"assets/menu-19.svg",ing:["Bawang putih","Cabai","Olive oil","Peterseli"]},
      {id:20,name:"Chicken Katsu Rice Bowl",price:38000,cat:"Makanan",img:"assets/menu-20.svg",ing:["Ayam fillet","Tepung roti","Nasi","Saus"]},
      {id:21,name:"Beef Teriyaki Rice Bowl",price:42000,cat:"Makanan",img:"assets/menu-21.svg",ing:["Daging sapi","Saus teriyaki","Nasi","Bawang bombay"]},
      {id:22,name:"Caesar Salad",price:32000,cat:"Makanan",img:"assets/menu-22.svg",ing:["Lettuce","Crouton","Parmesan","Dressing"]},
      {id:23,name:"Club Sandwich",price:34000,cat:"Makanan",img:"assets/menu-23.svg",ing:["Roti panggang","Dada ayam","Telur","Lettuce","Tomat"]},
      {id:24,name:"Waffle Maple",price:28000,cat:"Makanan",img:"assets/menu-24.svg",ing:["Adonan waffle","Maple syrup"]},
      {id:25,name:"Brownies",price:22000,cat:"Makanan",img:"assets/menu-25.svg",ing:["Cokelat","Mentega","Telur","Tepung"]},
    ];
    const TAX = .10;
    const fmt = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n).replace(",00","");

    const grid = document.getElementById('grid');
    const q = document.getElementById('q');
    const sort = document.getElementById('sort');
    const cats = document.getElementById('cats');
    let currentCat = "";

    function renderItems(){
      const query = (q.value||'').toLowerCase();
      const arr = MENU.filter(m => (!query || m.name.toLowerCase().includes(query)) && (!currentCat || m.cat===currentCat));
      switch(sort.value){
        case 'price-asc': arr.sort((a,b)=>a.price-b.price); break;
        case 'price-desc': arr.sort((a,b)=>b.price-a.price); break;
        case 'name-asc': arr.sort((a,b)=>a.name.localeCompare(b.name)); break;
        case 'name-desc': arr.sort((a,b)=>b.name.localeCompare(a.name)); break;
      }
      grid.innerHTML = '';
      arr.forEach(it => {
        const art = document.createElement('article');
        art.className = 'card';
        art.innerHTML = `
          <div style="position:relative">
            <img src="${it.img}" alt="${it.name}">
            <span class="pill">${it.cat}</span>
          </div>
          <div class="pad">
            <div style="display:flex; justify-content:space-between; gap:12px">
              <div>
                <strong style="font-size:18px">${it.name}</strong>
                <div style="color:var(--muted); font-size:13px">Bahan: ${it.ing.join(', ')}</div>
              </div>
              <div class="price">${fmt(it.price)}</div>
            </div>
            <textarea rows="2" class="textarea" placeholder='contoh: "tidak pedas ya"'></textarea>
            <div style="display:grid; grid-template-columns: auto 1fr auto; gap:8px; align-items:center; margin-top:10px">
              <button class="button ripple" data-act="minus">−</button>
              <input type="number" value="1" min="1" class="input" style="text-align:center">
              <button class="button ripple" data-act="plus">+</button>
              <button class="button primary ripple" style="grid-column: 1 / -1" data-act="add">Tambah</button>
            </div>
          </div>`;
        grid.appendChild(art);
        const qtyInput = art.querySelector('input[type="number"]');
        art.querySelector('[data-act="minus"]').addEventListener('click', ()=> qtyInput.value = Math.max(1, parseInt(qtyInput.value||'1',10)-1));
        art.querySelector('[data-act="plus"]').addEventListener('click',  ()=> qtyInput.value = Math.max(1, parseInt(qtyInput.value||'1',10)+1));
        art.querySelector('[data-act="add"]').addEventListener('click',  ()=> {
          const n = Math.max(1, parseInt(qtyInput.value||'1',10));
          const note = art.querySelector('textarea').value.trim();
          addToCart(it, n, note); showToast('Ditambahkan ke keranjang');
        });
      });
    }

    // Cart
    let cart = [];
    const keyOf = (id,note)=> id+'|'+(note||'');
    const side = { list:document.getElementById('listSide'), sub:document.getElementById('subSide'), tax:document.getElementById('taxSide'), tot:document.getElementById('totSide'), count:document.getElementById('countSide') };
    const draw = { list:document.getElementById('listDrawer'), sub:document.getElementById('subDrawer'), tax:document.getElementById('taxDrawer'), tot:document.getElementById('totDrawer'), count:document.getElementById('countDrawer') };
    const badge = document.getElementById('badge');

    function addToCart(it, qty, note){
      const k = keyOf(it.id, note); const f = cart.find(x=>x.key===k);
      if(f) f.qty += qty; else cart.push({key:k,id:it.id,name:it.name,price:it.price,qty,note});
      renderCart();
    }
    function rm(k){ cart = cart.filter(x=>x.key!==k); renderCart(); }
    function qd(k,d){ const f = cart.find(x=>x.key===k); if(!f) return; f.qty = Math.max(1, f.qty+d); renderCart(); }
    function count(){ return cart.reduce((a,c)=>a+c.qty,0); }

    function renderCart(){
      let sub=0;
      const rowHtml = (c)=>`<div class="row">
          <div style="min-width:0">
            <div style="font-weight:800">${c.name} × ${c.qty} <span style="font-size:12px; color:var(--muted)">• ${fmt(c.price)}</span></div>
            ${c.note ? `<div style="color:var(--muted); font-size:13px; margin-top:4px">Catatan: ${c.note}</div>` : ``}
          </div>
          <div style="display:flex; gap:6px">
            <button class="button ripple" onclick='qd("${c.key}",-1)'>−</button>
            <button class="button ripple" onclick='qd("${c.key}",1)'>+</button>
            <button class="button ripple" onclick='rm("${c.key}")'>✕</button>
          </div>
        </div>`;
      const rows = cart.map(c=>{ sub+=c.price*c.qty; return rowHtml(c); }).join('');
      const tax = Math.round(sub*TAX); const tot=sub+tax;

      side.list.innerHTML = rows || `<div style="color:var(--muted)">Belum ada item.</div>`;
      draw.list.innerHTML = rows || `<div style="color:var(--muted)">Belum ada item.</div>`;
      side.sub.textContent = fmt(sub); side.tax.textContent = fmt(tax); side.tot.textContent = fmt(tot); side.count.textContent = count();
      draw.sub.textContent = fmt(sub); draw.tax.textContent = fmt(tax); draw.tot.textContent = fmt(tot); draw.count.textContent = count();
      badge.textContent = count();
    }
    window.rm = rm; window.qd = qd;

    // Drawer
    const drawer = document.getElementById('drawer'); const mask = document.getElementById('mask');
    function openDrawer(){ drawer.classList.add('open'); mask.style.display='block'; }
    function closeDrawer(){ drawer.classList.remove('open'); mask.style.display='none'; }
    window.openDrawer = openDrawer; window.closeDrawer = closeDrawer;

    // Toast & Ripple
    const toast = document.getElementById('toast');
    function showToast(msg){ toast.querySelector('.inner').textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
    document.body.addEventListener('click', e => {
      const btn = e.target.closest('.ripple'); if(!btn) return;
      const r = btn.getBoundingClientRect(); btn.style.setProperty('--x', (e.clientX-r.left)+'px'); btn.style.setProperty('--y', (e.clientY-r.top)+'px');
      btn.classList.remove('rippling'); void btn.offsetWidth; btn.classList.add('rippling');
    }, {capture:true});

    // Filters
    q.addEventListener('input', renderItems);
    sort.addEventListener('change', renderItems);
    cats.addEventListener('click', e=> { const b = e.target.closest('button[data-cat]'); if(!b) return; currentCat = b.dataset.cat||''; renderItems(); });

    // Fields
    function rf(id){ return (document.getElementById(id+'Drawer')?.value?.trim?.() || document.getElementById(id+'Side')?.value?.trim?.() || ''); }
    function requireOrder(){
      if(cart.length===0){ alert("Keranjang masih kosong."); return false; }
      const name = rf('name'), phone = rf('phone'); if(!name || !phone){ alert("Isi nama & nomor HP terlebih dahulu."); return false; }
      return true;
    }
    function buildMessage(){
      const lines=[];
      lines.push('NJ Cafe — Pesanan Baru'); lines.push('========================');
      lines.push('Pelanggan : '+rf('name')); lines.push('No. HP    : '+rf('phone'));
      lines.push('Tipe      : '+(rf('type')||'Dine-in')); if(rf('addr')) lines.push('Alamat/Meja: '+rf('addr')); if(rf('note')) lines.push('Catatan   : '+rf('note'));
      lines.push(''); lines.push('Item:'); cart.forEach((c,i)=>{ lines.push((i+1)+'. '+c.name+' × '+c.qty+' — '+fmt(c.price*c.qty)); if(c.note) lines.push('   • Catatan: '+c.note); });
      lines.push(''); lines.push('Subtotal : '+document.getElementById('subSide').textContent); lines.push('Pajak 10%: '+document.getElementById('taxSide').textContent); lines.push('TOTAL    : '+document.getElementById('totSide').textContent);
      lines.push(''); lines.push('Waktu    : '+new Date().toLocaleString('id-ID')); lines.push('========================'); return lines.join('\n');
    }

    function sendWhatsApp(){
      if(!requireOrder()) return;
      const msg = buildMessage(); const phoneCafe = '6281282460257';
      const url = 'https://wa.me/'+phoneCafe+'?text='+encodeURIComponent(msg); const alt = 'https://api.whatsapp.com/send?phone='+phoneCafe+'&text='+encodeURIComponent(msg);
      window.open(url,'_blank') || window.open(alt,'_blank');
    }
    async function sendEmailServerless(btn){
      if(!requireOrder()) return;
      const original = btn.textContent; btn.textContent='Mengirim...'; btn.disabled = true;
      try{
        const subject = 'Pesanan NJ Cafe — '+rf('name'); const text = buildMessage();
        const res = await fetch('/api/send-email', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to:'narenskii@gmail.com', subject, text }) });
        if(!res.ok) throw new Error(await res.text() || ('HTTP '+res.status));
        showToast('Pesanan terkirim via email');
      }catch(e){ alert('Gagal mengirim email: '+(e && e.message ? e.message : e)); }
      finally{ btn.textContent = original; btn.disabled = false; }
    }
    window.sendWhatsApp = sendWhatsApp; window.sendEmailServerless = sendEmailServerless;

    // Initial
    renderItems(); renderCart();
  </script>
</body>
</html>
